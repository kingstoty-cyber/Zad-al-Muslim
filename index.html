
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق زاد المسلم v3.0</title>
    
    <!-- مكتبات خارجية -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&family=Amiri&display=swap" rel="stylesheet">
    
    <!-- ملفات التطبيق -->
    <link rel="stylesheet" href="styles.css">
</head>
<body id="app-body">

    <div class="header-section">
        <h1>زاد المسلم</h1>
        <p id="current-date"></p>
        <div id="current-theme"></div>

        <!-- زر سريع لفتح لوحة الإدخال اليدوي للموقع -->
        <button id="manual-toggle" style="margin-top:8px;padding:6px 10px;border-radius:8px;border:none;background:#f6bd26;color:#000;cursor:pointer;">
            <i class="fas fa-map-marker-alt"></i> تحديد الموقع يدوياً
        </button>
    </div>

    <main class="main-content">
        <div id="page-content"></div>
    </main>

    <div class="scroll-top" id="scrollTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </div>
        <div class="nav-item" data-tab="adhkar">
            <i class="fas fa-bead-tree"></i>
            <span>الأذكار</span>
        </div>
        <div class="nav-item" data-tab="tasbeeh">
            <i class="fas fa-circle-notch"></i>
            <span>المسبحة</span>
        </div>
        <div class="nav-item" data-tab="quran">
            <i class="fas fa-book-quran"></i>
            <span>الختمة</span>
        </div>
        <div class="nav-item" data-tab="themes">
            <i class="fas fa-palette"></i>
            <span>السمات</span>
        </div>
        <div class="nav-item" data-tab="settings">
            <i class="fas fa-user-gear"></i>
            <span>الإعدادات</span>
        </div>
    </nav>

    <!-- لوحة الإدخال اليدوي (مخفية افتراضياً) -->
    <div id="manual-location-panel" style="display:none; position:fixed; left:16px; right:16px; bottom:86px; z-index:9999;">
        <div style="background:rgba(0,0,0,0.8); padding:14px; border-radius:12px; color:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.6);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <strong>إدخال الموقع يدوياً</strong>
                <button id="manual-close" style="background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer;">إغلاق</button>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                <input id="manual-lat" placeholder="خط العرض (مثال: 24.7136)" type="number" step="0.0001"
                       style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff;">
                <input id="manual-lon" placeholder="خط الطول (مثال: 46.6753)" type="number" step="0.0001"
                       style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff;">
                <input id="manual-city" placeholder="المدينة (اختياري)" type="text"
                       style="flex:1 0 220px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff;">
            </div>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button id="save-manual-btn" style="background:#2ecc71;border:none;color:#000;padding:8px 12px;border-radius:8px;cursor:pointer;">حفظ الموقع وتحديث</button>
                <button id="clear-manual-btn" style="background:#e74c3c;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;">إزالة الموقع اليدوي</button>
                <div style="flex:1; align-self:center; color:#cbd6e1; font-size:0.85rem;">التحديث يحدث مرة يومياً أو عند الحفظ اليدوي</div>
            </div>
        </div>
    </div>

    <!-- ملفات JavaScript -->
    <script src="data.js"></script>
    <script src="app.js"></script>

    <!-- ربط واجهة الإدخال اليدوي بالأحداث (تعتمد على الدوال الموجودة في app.js) -->
    <script>
      (function(){
        const toggleBtn = document.getElementById('manual-toggle');
        const panel = document.getElementById('manual-location-panel');
        const closeBtn = document.getElementById('manual-close');
        const saveBtn = document.getElementById('save-manual-btn');
        const clearBtn = document.getElementById('clear-manual-btn');
        const latInput = document.getElementById('manual-lat');
        const lonInput = document.getElementById('manual-lon');
        const cityInput = document.getElementById('manual-city');

        function openPanel() {
          // ملء الحقول إن كان هناك موقع محفوظ
          if (typeof getManualLocation === 'function') {
            const m = getManualLocation();
            if (m) {
              latInput.value = m.lat;
              lonInput.value = m.lon;
              cityInput.value = m.city || '';
            } else {
              latInput.value = '';
              lonInput.value = '';
              cityInput.value = '';
            }
          }
          panel.style.display = 'block';
        }
        function closePanel(){ panel.style.display = 'none'; }

        toggleBtn && toggleBtn.addEventListener('click', openPanel);
        closeBtn && closeBtn.addEventListener('click', closePanel);

        saveBtn && saveBtn.addEventListener('click', async () => {
          const lat = parseFloat(latInput.value);
          const lon = parseFloat(lonInput.value);
          const city = cityInput.value.trim();

          if (Number.isNaN(lat) || Number.isNaN(lon)) {
            alert('يرجى إدخال قيم صحيحة لخط العرض وخط الطول.');
            return;
          }

          if (typeof saveManualLocation === 'function') {
            saveManualLocation(lat, lon, city);
          } else {
            localStorage.setItem('manual_location', JSON.stringify({lat, lon, city, source:'manual', timestamp: Date.now()}));
          }

          // اجبر تحديث المواقيت الآن
          if (typeof updatePrayerTimesWithFeedback === 'function') {
            await updatePrayerTimesWithFeedback();
          } else if (typeof updatePrayerTimes === 'function') {
            await updatePrayerTimes();
          }

          closePanel();
          // إعادة تحميل الصفحة الرئيسية لعرض التغيير إن لزم
          if (typeof renderHome === 'function') renderHome();
        });

        clearBtn && clearBtn.addEventListener('click', () => {
          if (!confirm('هل تريد إزالة الموقع اليدوي؟')) return;
          if (typeof clearManualLocation === 'function') {
            clearManualLocation();
          } else {
            localStorage.removeItem('manual_location');
          }
          // مسح الكاش حتى يعيد التحميل لاحقاً
          localStorage.removeItem('cached_prayer_times');
          alert('تمت إزالة الموقع اليدوي. سيتم استخدام GPS/IP أو الحساب المحلي عند التحديث التالي.');
          closePanel();
          if (typeof renderHome === 'function') renderHome();
        });

        // إغلاق عند الضغط خارج اللوحة
        window.addEventListener('click', (e) => {
          if (!panel.contains(e.target) && !toggleBtn.contains(e.target)) {
            // لا تغلق إذا كانت مخفية
            if (panel.style.display === 'block') panel.style.display = 'none';
          }
        });
      })();
    </script>
</body>
</html>
```